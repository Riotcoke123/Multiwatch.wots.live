<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Watch Multiple Streams of Wots.Live</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <link rel="stylesheet" href="styles.css">

</head>
<body>
  <div style="text-align: center; margin: 20px 0;">
    <img src="wots.png" alt="Wots.Live logo">
  </div>

  <div id="live-section">
    <img src="live.jpg" alt="Live" class="status-logo">Live Streams
    <div id="streams-live"></div>
  </div>

  <div id="offline-section">
    <img src="offline.png" alt="Offline" class="status-logo">Offline VODs
    <div id="streams-offline"></div>
  </div>

  <script>
    async function fetchStreams() {
      const res = await fetch("/streams");
      return await res.json();
    }

    // Create video element with HLS support
    function createVideoElement(url, muted = true, isLive = false) {
      const video = document.createElement("video");
      video.controls = true;
      video.autoplay = false;
      video.muted = muted;
      video.dataset.src = url;
      video.dataset.isLive = isLive ? "true" : "false";

      if (Hls.isSupported()) {
        video.dataset.hls = "true";
      }

      return video;
    }

    // Intersection Observer for lazy autoplay (LIVE ONLY)
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        const video = entry.target;
        if (entry.isIntersecting && video.dataset.isLive === "true") {
          if (video.dataset.hls && !video.dataset.loaded) {
            const hls = new Hls();
            hls.loadSource(video.dataset.src);
            hls.attachMedia(video);
            video.dataset.loaded = "true";
          } else if (!video.src) {
            video.src = video.dataset.src;
          }
          video.play().catch(() => {});
          video.style.opacity = 1;
        } else if (video.dataset.isLive === "true") {
          video.pause();
          video.style.opacity = 0.5;
        }
      });
    }, { threshold: 0.25 });

    async function refreshStreamsUI() {
      const streams = await fetchStreams();
      const liveContainer = document.getElementById("streams-live");
      const offlineContainer = document.getElementById("streams-offline");

      // Clear current
      liveContainer.innerHTML = "";
      offlineContainer.innerHTML = "";

      streams.forEach(user => {
        const container = user.isLive ? liveContainer : offlineContainer;
        const div = document.createElement("div");
        div.className = "widget";
        div.dataset.username = user.username;

        // Profile
        const img = document.createElement("img");
        img.className = "profile";
        img.src = user.profile_picture_url || "https://via.placeholder.com/80";
        div.appendChild(img);

        // Username
        const usernameEl = document.createElement("div");
        usernameEl.className = "username";
        usernameEl.textContent = user.username;
        div.appendChild(usernameEl);

        let videoAdded = false;

        if (user.isLive && user.live?.playbackUrls?.length > 0) {
          const video = createVideoElement(user.live.playbackUrls[0], true, true);
          div.appendChild(video);
          observer.observe(video); // lazy autoplay
          videoAdded = true;

          if (user.live.title) {
            const title = document.createElement("div");
            title.className = "title";
            title.textContent = user.live.title;
            div.appendChild(title);
          }
          if (user.live.viewerCount !== undefined) {
            const viewers = document.createElement("div");
            viewers.className = "viewers";
            viewers.textContent = `${user.live.viewerCount} viewers`;
            div.appendChild(viewers);
          }
        } else if (!user.isLive && user.vod?.vodPlaybackUrl) {
          const vodWrapper = document.createElement("div");
          vodWrapper.className = "vod-container";
          vodWrapper.style.position = "relative";

          const video = createVideoElement(user.vod.vodPlaybackUrl, false, false);
          vodWrapper.appendChild(video);

          // Overlay button
          const overlay = document.createElement("div");
          overlay.className = "overlay";
          overlay.textContent = "â–¶ Click to Play";
          vodWrapper.appendChild(overlay);

          // Click-to-play for offline VOD
          const startVod = () => {
            if (video.dataset.hls && !video.dataset.loaded) {
              const hls = new Hls();
              hls.loadSource(video.dataset.src);
              hls.attachMedia(video);
              video.dataset.loaded = "true";
            } else if (!video.src) {
              video.src = video.dataset.src;
            }
            video.play();
            overlay.style.display = "none";
          };

          overlay.addEventListener("click", startVod);
          video.addEventListener("click", startVod);

          div.appendChild(vodWrapper);
          videoAdded = true;
        }

        if (!videoAdded) {
          const info = document.createElement("div");
          info.className = "title";
          info.textContent = "No recent VOD available";
          div.appendChild(info);
        }

        container.appendChild(div);
      });
    }

    // Initial load
    refreshStreamsUI();
    // Refresh every 5 seconds
    setInterval(refreshStreamsUI, 5000);
  </script>
</body>
</html>
